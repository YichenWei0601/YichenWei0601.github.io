<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mars Profile - owei</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gugi&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
            cursor: none;
        }
        
        * {
            cursor: none !important;
        }
        
        #starfield {
            display: block;
            background: radial-gradient(ellipse at center, #2e1a1a 0%, #000 100%);
            position: absolute;
            z-index: 1;
        }
        
        #mars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        #mars-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            overflow: hidden;
            cursor: none !important;
            transition: all 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 2;
            pointer-events: auto;
        }
        
        #mars-canvas.zoomed {
            transform: translate(-140%, -50%) scale(1.5);
            border-radius: 50%;
            width: 300px;
            height: 300px;
            z-index: 10;
        }
        
        #mars-canvas:hover {
            filter: brightness(0.8);
            box-shadow: 0 0 300px rgba(255, 100, 50, 0.3);
        }
        
        #mars-canvas.zoomed:hover {
            filter: brightness(1.05);
        }
        
        /* 页面切换箭头 */
        .page-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            cursor: none !important;
            transition: all 0.3s ease;
            z-index: 100;
            user-select: none;
        }
        
        .page-nav:hover {
            background: transparent;
            border: none;
            box-shadow: none;
            transform: translateY(-50%) scale(1.1);
        }
        
        .page-nav.left {
            left: 30px;
            border-radius: 0 20px 20px 0;
        }
        
        .page-nav.right {
            right: 30px;
            border-radius: 20px 0 0 20px;
        }
        
        .page-nav .arrow {
            color: #ffffff;
            font-size: 32px;
            font-weight: bold;
            font-family: 'Gloria Hallelujah', cursive;
            transition: color 0.3s ease;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .page-nav:hover .arrow {
            color: #ff6432;
            text-shadow: 0 0 20px rgba(255, 100, 50, 0.8);
        }
        
        /* 项目列表样式 */
        .project-list {
            position: fixed;
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
            width: 560px;
            height: 400px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s ease;
            z-index: 15;
            pointer-events: none;
        }
        
        .project-list.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        .project-list-content {
            height: 200%;
            opacity: 0;
            transition: opacity 1.5s ease 0.5s;
        }
        
        .project-list.visible .project-list-content {
            opacity: 1;
        }
        
        .project-item {
            margin: 15px 0;
            padding: 0;
            background: transparent;
            border: none;
            transition: all 0.3s ease;
        }
        
        .project-item a {
            color: #ffffff;
            text-decoration: none;
            font-size: 28px;
            font-weight: 400;
            font-family: 'Gugi', sans-serif;
            display: block;
            transition: color 0.3s ease;
        }
        
        .project-item a:hover {
            color: #ff6432;
        }
        
        .project-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            font-family: 'Gugi', sans-serif;
            margin-top: 5px;
        }
        
        /* Markdown内容显示区域 */
        .markdown-display {
            position: fixed;
            right: 5%;
            top: 50%;
            transform: translateY(-50%);
            width: 650px;
            height: 500px;
            background: rgba(40, 20, 20, 0.85);
            border: 1px solid rgba(255, 100, 50, 0.2);
            border-radius: 12px;
            padding: 30px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s ease;
            z-index: 20;
            pointer-events: none;
            backdrop-filter: blur(10px);
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .markdown-display.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        .markdown-display::-webkit-scrollbar {
            width: 6px;
        }
        
        .markdown-display::-webkit-scrollbar-track {
            background: rgba(255, 100, 50, 0.1);
            border-radius: 3px;
        }
        
        .markdown-display::-webkit-scrollbar-thumb {
            background: rgba(255, 100, 50, 0.3);
            border-radius: 3px;
        }
        
        .markdown-display::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 100, 50, 0.5);
        }
        
        .markdown-content {
            color: #ffffff;
            font-family: 'Gugi', sans-serif;
            line-height: 1.6;
        }
        
        .markdown-content h1 {
            color: #ff6432;
            font-size: 32px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ff6432;
            padding-bottom: 10px;
        }
        
        .markdown-content h2 {
            color: #ffffff;
            font-size: 24px;
            margin: 25px 0 15px 0;
        }
        
        .markdown-content h3 {
            color: #cccccc;
            font-size: 20px;
            margin: 20px 0 10px 0;
        }
        
        .markdown-content p {
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .markdown-content li {
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .markdown-content code {
            background: rgba(255, 100, 50, 0.1);
            color: #ff6432;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .markdown-content pre {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 100, 50, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        
        .markdown-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: none !important;
            transition: color 0.3s ease;
            z-index: 21;
        }
        
        .markdown-close-btn:hover {
            color: #ff6432;
        }
        
        /* 音乐控制按钮样式 */
        .music-control {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
        }
        
        #music-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(40, 20, 20, 0.8);
            border: 2px solid rgba(255, 100, 50, 0.3);
            color: #ffffff;
            cursor: none !important;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        #music-toggle:hover {
            background: rgba(255, 100, 50, 0.2);
            border-color: #ff6432;
            box-shadow: 0 0 20px rgba(255, 100, 50, 0.3);
            transform: scale(1.1);
        }
        
        #music-icon {
            line-height: 1;
            display: block;
        }

        /* Test Topic 样式 */
        .test-topic {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Gloria Hallelujah', cursive;
            font-size: 48px;
            color: #ff6432;
            text-shadow: 0 0 20px rgba(255, 100, 50, 0.8),
                         0 0 40px rgba(255, 100, 50, 0.6),
                         0 0 60px rgba(255, 100, 50, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            pointer-events: none;
        }

        .test-topic.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* 自定义光标 */
        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: difference;
            transition: transform 0.1s ease;
        }
        
        .custom-cursor::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>
    
    <!-- 火星容器 -->
    <div id="mars-container">
        <div id="mars-canvas"></div>
    </div>

    <!-- 页面导航箭头 -->
    <div class="page-nav left" onclick="switchToMoon()">
        <div class="arrow">&lt;</div>
    </div>
    <div class="page-nav right" onclick="switchToJupiter()">
        <div class="arrow">&gt;</div>
    </div>

    <!-- 音频元素 -->
    <audio id="background-music" loop preload="auto">
        <source src="music/Horizon_daft_punk.mp3" type="audio/mpeg">
        您的浏览器不支持音频播放。
    </audio>

    <!-- 音乐控制按钮 -->
    <div class="music-control" id="music-control">
        <button id="music-toggle" onclick="toggleMusic()">
            <span id="music-icon">⏹︎️</span>
        </button>
    </div>

    <!-- Test Topic -->
    <div class="test-topic" id="test-topic">Test Topic</div>

    <!-- 项目列表 -->
    <div class="project-list" id="project-list">
        <div class="project-list-content">
            <!-- Mars 项目列表 -->
            <div class="project-item">
                <a href="#" onclick="openProject('mars1')">Mars Mission</a>
                <div class="project-description">火星探索任务</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars2')">Rover Tech</a>
                <div class="project-description">火星车技术</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars3')">Atmosphere Study</a>
                <div class="project-description">大气层研究</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars4')">Terraforming</a>
                <div class="project-description">地球化改造</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars5')">Life Search</a>
                <div class="project-description">生命探索</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars6')">Colony Planning</a>
                <div class="project-description">殖民地规划</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars7')">Resource Mining</a>
                <div class="project-description">资源开采</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars8')">Communication</a>
                <div class="project-description">通信系统</div>
            </div>
            <!-- 重复内容实现无缝循环 -->
            <div class="project-item">
                <a href="#" onclick="openProject('mars1')">Mars Mission</a>
                <div class="project-description">火星探索任务</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars2')">Rover Tech</a>
                <div class="project-description">火星车技术</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars3')">Atmosphere Study</a>
                <div class="project-description">大气层研究</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars4')">Terraforming</a>
                <div class="project-description">地球化改造</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars5')">Life Search</a>
                <div class="project-description">生命探索</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars6')">Colony Planning</a>
                <div class="project-description">殖民地规划</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars7')">Resource Mining</a>
                <div class="project-description">资源开采</div>
            </div>
            <div class="project-item">
                <a href="#" onclick="openProject('mars8')">Communication</a>
                <div class="project-description">通信系统</div>
            </div>
        </div>
    </div>

    <!-- Markdown内容显示区域 -->
    <div class="markdown-display" id="markdown-display">
        <button class="markdown-close-btn" onclick="closeMarkdownDisplay()">&times;</button>
        <div class="markdown-content" id="markdown-content">
            <!-- markdown内容将动态加载到这里 -->
        </div>
    </div>

    <!-- Three.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // 全局变量
        let isZoomedIn = false;
        let mars3DInstance = null;
        let backgroundMusic = null;
        let isMusicPlaying = false;
        
        // 页面切换功能
        function switchToMoon() {
            // 保存当前音乐播放时间和状态
            if (backgroundMusic) {
                localStorage.setItem('musicTime', backgroundMusic.currentTime.toString());
                localStorage.setItem('musicPlaying', isMusicPlaying.toString());
            }
            window.location.href = 'moon.html';
        }
        
        function switchToJupiter() {
            // 保存当前音乐播放时间和状态
            if (backgroundMusic) {
                localStorage.setItem('musicTime', backgroundMusic.currentTime.toString());
                localStorage.setItem('musicPlaying', isMusicPlaying.toString());
            }
            window.location.href = 'jupiter.html';
        }
        
        // 音乐控制功能
        function initMusic() {
            backgroundMusic = document.getElementById('background-music');
            const musicIcon = document.getElementById('music-icon');
            
            // 设置音量
            backgroundMusic.volume = 0.3;
            
            // 从localStorage恢复音乐播放状态和时间
            const savedMusicState = localStorage.getItem('musicPlaying');
            const savedMusicTime = localStorage.getItem('musicTime');
            
            // 如果有保存的播放时间，设置音乐当前时间
            if (savedMusicTime) {
                backgroundMusic.currentTime = parseFloat(savedMusicTime);
            }
            
            // 根据保存的状态决定是否播放音乐
            if (savedMusicState === 'true') {
                const playPromise = backgroundMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isMusicPlaying = true;
                        musicIcon.textContent = '⏹︎';
                        console.log('音乐继续播放成功');
                    }).catch((error) => {
                        console.log('自动播放被阻止，需要用户交互:', error);
                        isMusicPlaying = false;
                        musicIcon.textContent = '▶︎';
                    });
                }
            } else {
                // 如果之前是暂停状态，显示播放按钮
                isMusicPlaying = false;
                musicIcon.textContent = '▶︎';
            }
            
            // 监听音频事件
            backgroundMusic.addEventListener('ended', () => {
                console.log('音乐播放结束');
            });
            
            backgroundMusic.addEventListener('error', (e) => {
                console.error('音乐加载失败:', e);
                musicIcon.textContent = '❌';
            });
        }
        
        // 切换音乐播放/暂停
        function toggleMusic() {
            const musicIcon = document.getElementById('music-icon');
            
            if (!backgroundMusic) {
                console.error('音频元素未找到');
                return;
            }
            
            if (isMusicPlaying) {
                // 暂停音乐
                backgroundMusic.pause();
                isMusicPlaying = false;
                musicIcon.textContent = '▶︎';
                localStorage.setItem('musicPlaying', 'false');
                localStorage.setItem('musicTime', backgroundMusic.currentTime.toString());
            } else {
                // 播放音乐
                const playPromise = backgroundMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isMusicPlaying = true;
                        musicIcon.textContent = '⏹︎';
                        localStorage.setItem('musicPlaying', 'true');
                    }).catch((error) => {
                        console.error('播放失败:', error);
                        musicIcon.textContent = '❌';
                        localStorage.setItem('musicPlaying', 'false');
                    });
                }
            }
        }
        
        // 火星点击处理
        function handleMarsClick() {
            const marsCanvas = document.getElementById('mars-canvas');
            const projectList = document.getElementById('project-list');
            const markdownDisplay = document.getElementById('markdown-display');
            const testTopic = document.getElementById('test-topic');
            
            // 如果markdown显示区域是可见的，优先关闭它并回到首页
            if (markdownDisplay.classList.contains('visible')) {
                markdownDisplay.classList.remove('visible');
                // 延迟一点时间再恢复到首页状态，确保动画流畅
                setTimeout(() => {
                    marsCanvas.classList.remove('zoomed');
                    projectList.classList.remove('visible');
                    testTopic.classList.remove('visible');
                    isZoomedIn = false;
                    
                    if (mars3DInstance) {
                        mars3DInstance.zoomOut();
                    }
                }, 300);
                return;
            }
            
            if (!isZoomedIn) {
                // 放大火星并移动到左侧
                marsCanvas.classList.add('zoomed');
                projectList.classList.add('visible');
                testTopic.classList.add('visible');
                isZoomedIn = true;
                
                // 调整火星相机以显示更多细节
                if (mars3DInstance) {
                    mars3DInstance.zoomIn();
                }
            } else {
                // 恢复原始状态
                marsCanvas.classList.remove('zoomed');
                projectList.classList.remove('visible');
                testTopic.classList.remove('visible');
                isZoomedIn = false;
                
                if (mars3DInstance) {
                    mars3DInstance.zoomOut();
                }
            }
        }

        // 项目点击处理
        function openProject(projectName) {
            loadMarkdownContent(projectName);
        }
        
        // 加载并显示Markdown内容
        async function loadMarkdownContent(projectName) {
            const projectList = document.getElementById('project-list');
            const markdownDisplay = document.getElementById('markdown-display');
            const markdownContent = document.getElementById('markdown-content');
            const testTopic = document.getElementById('test-topic');
            
            // 隐藏项目列表和Test Topic
            projectList.classList.remove('visible');
            testTopic.classList.remove('visible');
            
            // 显示加载状态
            markdownContent.innerHTML = '<p>加载中...</p>';
            markdownDisplay.classList.add('visible');
            
            try {
                // 构建markdown文件路径
                const markdownPath = `mars/${projectName}/index.md`;
                
                // 尝试从实际文件加载内容
                let content;
                try {
                    const response = await fetch(markdownPath);
                    if (response.ok) {
                        content = await response.text();
                    } else {
                        throw new Error('文件加载失败');
                    }
                } catch (fetchError) {
                    // 如果无法加载文件，使用预定义内容
                    console.log('使用预定义内容:', fetchError.message);
                    content = await loadMarkdownFromPath(projectName);
                }
                
                // 将markdown转换为HTML并显示
                const htmlContent = parseMarkdownToHTML(content);
                markdownContent.innerHTML = htmlContent;
                
            } catch (error) {
                console.error('加载markdown内容失败:', error);
                markdownContent.innerHTML = `
                    <h1>${projectName.toUpperCase()} 项目</h1>
                    <p>抱歉，无法加载项目详情。</p>
                    <p>这是一个示例项目，展示了火星探索相关技术。</p>
                `;
            }
        }
        
        // 模拟从本地文件加载markdown内容
        async function loadMarkdownFromPath(projectName) {
            // 火星项目的预定义内容
            const markdownContents = {
                'mars1': `# Mars Mission
                
## 火星探索任务概述
火星，这颗红色星球一直是人类探索宇宙的重要目标。

### 历史任务
- 海盗号着陆器
- 勇气号火星车
- 机遇号火星车
- 好奇号火星车
- 毅力号火星车

### 未来计划
探索火星生命迹象，为人类登陆做准备。`,
                
                'mars2': `# Rover Technology
                
## 火星车技术发展
先进的机器人技术使我们能够远程探索火星表面。

### 核心技术
- 核动力系统
- 自主导航
- 科学仪器套件
- 通信系统

### 技术挑战
极端温度、辐射环境、通信延迟。`,
                
                'mars3': `# Atmosphere Study
                
## 火星大气层研究
了解火星大气组成对未来殖民至关重要。

### 大气成分
- 95.3% 二氧化碳
- 2.7% 氮气
- 1.6% 氩气
- 微量氧气和水蒸气

### 气候变化
季节性变化、沙尘暴、极地冰盖。`,
                
                'mars4': `# Terraforming
                
## 火星地球化改造
将火星环境改造为适合人类居住的星球。

### 改造方案
- 增厚大气层
- 提高温度
- 创造磁场
- 引入液态水

### 技术挑战
时间尺度巨大，技术复杂度极高。`,
                
                'mars5': `# Life Search
                
## 火星生命探索
寻找火星上过去或现在的生命迹象。

### 探索目标
- 微生物化石
- 有机化合物
- 地下水系统
- 生物标记

### 发现意义
将彻底改变我们对生命的理解。`,
                
                'mars6': `# Colony Planning
                
## 火星殖民地规划
建立可持续的人类火星居住地。

### 基础设施
- 居住舱
- 生命支持系统
- 农业设施
- 能源系统

### 挑战与解决方案
资源利用、心理健康、医疗保障。`,
                
                'mars7': `# Resource Mining
                
## 火星资源开采
利用火星本地资源支持殖民活动。

### 主要资源
- 水冰
- 二氧化碳
- 铁矿石
- 稀土元素

### 开采技术
原位资源利用（ISRU）技术。`,
                
                'mars8': `# Communication
                
## 火星通信系统
建立地球与火星之间的可靠通信。

### 通信挑战
- 信号延迟（4-24分钟）
- 行星遮挡
- 信号衰减

### 解决方案
卫星中继、深空网络、激光通信。`
            };
            
            return markdownContents[projectName] || `# ${projectName.toUpperCase()}项目\n\n项目详情开发中...`;
        }
        
        // 简单的Markdown到HTML转换器
        function parseMarkdownToHTML(markdown) {
            let html = markdown;
            
            // 转换标题
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // 转换代码块
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // 转换行内代码
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // 转换列表
            html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // 转换复选框列表
            html = html.replace(/- \[x\] (.*$)/gm, '<li>✓ $1</li>');
            html = html.replace(/- \[ \] (.*$)/gm, '<li>○ $1</li>');
            
            // 转换段落
            html = html.replace(/^(?!<[h|u|p|l])(.+)$/gm, '<p>$1</p>');
            
            // 清理多余的空段落
            html = html.replace(/<p><\/p>/g, '');
            
            return html;
        }
        
        // 关闭Markdown显示区域
        function closeMarkdownDisplay() {
            const projectList = document.getElementById('project-list');
            const markdownDisplay = document.getElementById('markdown-display');
            const testTopic = document.getElementById('test-topic');
            
            // 隐藏markdown显示区域
            markdownDisplay.classList.remove('visible');
            
            // 延迟显示项目列表和Test Topic，创建平滑过渡
            setTimeout(() => {
                projectList.classList.add('visible');
                testTopic.classList.add('visible');
            }, 300);
        }
        
        // 初始化Markdown显示区域的滚动功能
        function initMarkdownScroll() {
            const markdownDisplay = document.getElementById('markdown-display');
            
            // 添加滚轮事件处理
            markdownDisplay.addEventListener('wheel', (event) => {
                // 只有当markdown显示区域可见时才处理滚轮事件
                if (!markdownDisplay.classList.contains('visible')) return;
                
                event.preventDefault();
                event.stopPropagation();
                
                // 获取当前滚动位置
                const currentScrollTop = markdownDisplay.scrollTop;
                const scrollHeight = markdownDisplay.scrollHeight;
                const clientHeight = markdownDisplay.clientHeight;
                
                // 计算滚动增量
                const scrollDelta = event.deltaY * 0.8;
                
                // 计算新的滚动位置
                let newScrollTop = currentScrollTop + scrollDelta;
                
                // 确保滚动位置在有效范围内
                newScrollTop = Math.max(0, Math.min(newScrollTop, scrollHeight - clientHeight));
                
                // 应用新的滚动位置
                markdownDisplay.scrollTop = newScrollTop;
                
            }, { passive: false });
            
            // 阻止在markdown区域内的其他滚轮事件冒泡
            markdownDisplay.addEventListener('mouseenter', () => {
                const starfield = window.starfieldInstance;
                if (starfield) {
                    starfield.markdownScrollActive = true;
                }
            });
            
            markdownDisplay.addEventListener('mouseleave', () => {
                const starfield = window.starfieldInstance;
                if (starfield) {
                    starfield.markdownScrollActive = false;
                }
            });
        }

        // 项目列表鼠标滚轮控制
        function initProjectListScroll() {
            const projectList = document.getElementById('project-list');
            const projectListContent = document.querySelector('.project-list-content');
            
            let scrollPosition = 0;
            let animationFrame;
            let lastTime = 0;
            let userScrolling = false;
            let userScrollTimeout;

            function getContentHeight() {
                return projectListContent.scrollHeight / 2;
            }

            function autoScroll(currentTime) {
                if (!lastTime) lastTime = currentTime;
                const deltaTime = currentTime - lastTime;
                lastTime = currentTime;
                
                if (!userScrolling && projectList.classList.contains('visible')) {
                    const scrollSpeed = 50;
                    scrollPosition += (scrollSpeed * deltaTime) / 1000;
                    
                    const contentHeight = getContentHeight();
                    
                    if (scrollPosition >= contentHeight) {
                        scrollPosition = scrollPosition % contentHeight;
                    }
                    
                    projectListContent.style.transform = `translateY(-${scrollPosition}px)`;
                }
                
                animationFrame = requestAnimationFrame(autoScroll);
            }

            autoScroll(0);

            projectList.addEventListener('wheel', (event) => {
                if (!projectList.classList.contains('visible')) return;
                
                event.preventDefault();
                
                userScrolling = true;
                
                if (userScrollTimeout) {
                    clearTimeout(userScrollTimeout);
                }
                
                const contentHeight = getContentHeight();
                scrollPosition += event.deltaY * 0.5;

                if (scrollPosition >= contentHeight) {
                    scrollPosition = scrollPosition % contentHeight;
                } else if (scrollPosition < 0) {
                    scrollPosition = contentHeight + (scrollPosition % contentHeight);
                }
                
                projectListContent.style.transform = `translateY(-${scrollPosition}px)`;
                lastTime = 0;
                
                userScrollTimeout = setTimeout(() => {
                    userScrolling = false;
                    lastTime = 0;
                }, 2000);
                
            }, { passive: false });
        }

        // 3D火星类
        class Mars3D {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
                this.renderer.setSize(300, 300);
                this.renderer.setClearColor(0x000000, 0);
                
                const container = document.getElementById('mars-canvas');
                container.appendChild(this.renderer.domElement);
                
                // 添加点击事件
                container.addEventListener('click', handleMarsClick);

                this.setupLighting();
                this.createMars();
                this.setupCamera();
                this.animate();
                
                // 保存实例引用
                mars3DInstance = this;
            }
            
            setupLighting() {
                // 主光源 - 模拟太阳光，火星接收的光照较弱
                const directionalLight = new THREE.DirectionalLight(0xffaa66, 1.5);
                directionalLight.position.set(8, 3, 8);
                this.scene.add(directionalLight);
                
                // 环境光 - 火星大气散射
                const ambientLight = new THREE.AmbientLight(0x554433, 0.2);
                this.scene.add(ambientLight);
                
                // 补充光源 - 模拟大气散射的红光
                const atmosphereLight = new THREE.DirectionalLight(0xff4422, 0.3);
                atmosphereLight.position.set(-5, -2, 3);
                this.scene.add(atmosphereLight);
            }
            
            createMars() {
                const geometry = new THREE.SphereGeometry(2, 64, 64);
                
                // 创建火星材质
                const material = new THREE.MeshLambertMaterial({
                    color: 0xffffff,
                    transparent: false
                });
                
                // 立即创建程序化纹理
                this.createProceduralTexture(material);
                
                // 创建火星网格并添加到场景
                this.mars = new THREE.Mesh(geometry, material);
                this.scene.add(this.mars);
                
                // 在后台异步加载高质量纹理
                this.loadHighQualityTextures(material);
            }
            
            loadHighQualityTextures(material) {
                const textureLoader = new THREE.TextureLoader();
                
                // 优先使用本地贴图
                const localTexturePath = 'pic/mars.jpg';
                
                textureLoader.load(
                    localTexturePath,
                    (texture) => {
                        // 本地火星贴图加载成功
                        texture.wrapS = THREE.RepeatWrapping;
                        texture.wrapT = THREE.ClampToEdgeWrapping;
                        texture.flipY = false;
                        texture.anisotropy = this.renderer.capabilities.getMaxAnisotropy();
                        material.map = texture;
                        material.needsUpdate = true;
                        console.log('本地火星贴图加载成功');
                    },
                    (progress) => {
                        console.log('火星贴图加载进度:', (progress.loaded / progress.total * 100) + '%');
                    },
                    (error) => {
                        console.error('本地火星贴图加载失败，尝试网络纹理:', error);
                        this.loadNetworkTextures(material);
                    }
                );
            }
            
            loadNetworkTextures(material) {
                const textureLoader = new THREE.TextureLoader();
                
                const loadWithTimeout = (url, timeout = 3000) => {
                    return new Promise((resolve, reject) => {
                        const timer = setTimeout(() => {
                            reject(new Error('Texture load timeout'));
                        }, timeout);
                        
                        textureLoader.load(
                            url,
                            (texture) => {
                                clearTimeout(timer);
                                resolve(texture);
                            },
                            undefined,
                            (error) => {
                                clearTimeout(timer);
                                reject(error);
                            }
                        );
                    });
                };
                
                // 网络备用火星纹理
                const textureUrls = [
                    'https://planetarymaps.usgs.gov/mosaic/mars/mgs_mola_color_map.jpg',
                    'https://planetpixelemporium.com/download/download.php?file=mars_8k.jpg',
                    'https://www.solarsystemscope.com/textures/download/2k_mars.jpg'
                ];
                
                // 并行尝试所有纹理源
                Promise.any(textureUrls.map(url => loadWithTimeout(url, 3000)))
                    .then((texture) => {
                        texture.wrapS = THREE.RepeatWrapping;
                        texture.wrapT = THREE.ClampToEdgeWrapping;
                        texture.flipY = false;
                        material.map = texture;
                        material.needsUpdate = true;
                        console.log('网络火星纹理加载成功');
                    })
                    .catch(() => {
                        console.log('所有纹理加载失败，使用程序化火星纹理');
                    });
            }
            
            createProceduralTexture(material) {
                // 创建程序化火星纹理
                const canvas = document.createElement('canvas');
                canvas.width = 1024;
                canvas.height = 512;
                const context = canvas.getContext('2d');
                
                // 创建火星基础颜色渐变
                const gradient = context.createLinearGradient(0, 0, 0, 512);
                gradient.addColorStop(0, '#cd5c5c');
                gradient.addColorStop(0.3, '#b22222');
                gradient.addColorStop(0.7, '#8b0000');
                gradient.addColorStop(1, '#654321');
                
                context.fillStyle = gradient;
                context.fillRect(0, 0, 1024, 512);
                
                // 添加噪声纹理
                const imageData = context.getImageData(0, 0, 1024, 512);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const noise = (Math.random() - 0.5) * 40;
                    data[i] = Math.max(0, Math.min(255, data[i] + noise));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise * 0.5));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise * 0.3));
                }
                
                context.putImageData(imageData, 0, 0);
                
                // 添加火星特征 - 极地冰盖
                const polarCaps = [
                    {x: 512, y: 50, r: 80, color: 'rgba(255, 255, 255, 0.6)'},
                    {x: 512, y: 462, r: 60, color: 'rgba(255, 255, 255, 0.4)'}
                ];
                
                polarCaps.forEach(cap => {
                    const gradient = context.createRadialGradient(
                        cap.x, cap.y, 0,
                        cap.x, cap.y, cap.r
                    );
                    gradient.addColorStop(0, cap.color);
                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    
                    context.fillStyle = gradient;
                    context.beginPath();
                    context.arc(cap.x, cap.y, cap.r, 0, Math.PI * 2);
                    context.fill();
                });
                
                // 添加火山和峡谷
                const features = [
                    {x: 200, y: 256, r: 60, darkness: 0.4}, // 奥林帕斯山
                    {x: 600, y: 200, r: 40, darkness: 0.3},
                    {x: 800, y: 300, r: 50, darkness: 0.35}
                ];
                
                features.forEach(feature => {
                    const gradient = context.createRadialGradient(
                        feature.x, feature.y, 0,
                        feature.x, feature.y, feature.r
                    );
                    gradient.addColorStop(0, `rgba(139, 69, 19, ${feature.darkness})`);
                    gradient.addColorStop(0.7, `rgba(160, 82, 45, ${feature.darkness * 0.5})`);
                    gradient.addColorStop(1, 'rgba(205, 92, 92, 0)');
                    
                    context.fillStyle = gradient;
                    context.beginPath();
                    context.arc(feature.x, feature.y, feature.r, 0, Math.PI * 2);
                    context.fill();
                });
                
                // 添加撞击坑
                for (let i = 0; i < 80; i++) {
                    const x = Math.random() * 1024;
                    const y = Math.random() * 512;
                    const radius = Math.random() * 12 + 3;
                    const darkness = Math.random() * 0.2 + 0.1;
                    
                    const gradient = context.createRadialGradient(
                        x, y, 0,
                        x, y, radius
                    );
                    gradient.addColorStop(0, `rgba(101, 67, 33, ${darkness})`);
                    gradient.addColorStop(0.6, `rgba(139, 69, 19, ${darkness * 0.5})`);
                    gradient.addColorStop(1, 'rgba(205, 92, 92, 0)');
                    
                    context.fillStyle = gradient;
                    context.beginPath();
                    context.arc(x, y, radius, 0, Math.PI * 2);
                    context.fill();
                }
                
                // 创建纹理
                const texture = new THREE.CanvasTexture(canvas);
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.ClampToEdgeWrapping;
                texture.flipY = false;
                
                material.map = texture;
                material.needsUpdate = true;
            }
            
            setupCamera() {
                this.camera.position.z = 6;
            }
            
            zoomIn() {
                // CSS变换处理缩放
            }
            
            zoomOut() {
                // CSS变换处理缩放
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.mars) {
                    this.mars.rotation.y += 0.001; // 火星自转稍慢
                    this.mars.rotation.x += 0.0003;
                }
                this.renderer.render(this.scene, this.camera);
            }
        }

        class Star {
            constructor(x, y, z) {
                this.x = x;
                this.y = y;
                this.z = z;
                this.prevX = 0;
                this.prevY = 0;
                this.opacity = 1;
                this.size = Math.random() * 2 + 0.5;
                this.color = this.generateStarColor();
            }
            
            generateStarColor() {
                // 火星主题的星星颜色 - 更多暖色调
                const colors = [
                    '#ffffff',
                    '#ffddaa',
                    '#ffaa66',
                    '#ff8844',
                    '#ffccaa',
                    '#ffaa88'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            update(speed, mouseX, mouseY) {
                this.prevX = this.screenX || 0;
                this.prevY = this.screenY || 0;
                
                this.z -= speed;
                
                if (this.z <= 0) {
                    this.z = 1000;
                    this.x = (Math.random() - 0.5) * 2000;
                    this.y = (Math.random() - 0.5) * 2000;
                    this.color = this.generateStarColor();
                }
                
                const perspective = 800;
                const marsElement = document.getElementById('mars-canvas');
                const marsRect = marsElement.getBoundingClientRect();
                const marsCenterX = marsRect.left + marsRect.width / 2;
                const marsCenterY = marsRect.top + marsRect.height / 2;
                
                this.screenX = (this.x / this.z) * perspective + marsCenterX + mouseX * 0.2;
                this.screenY = (this.y / this.z) * perspective + marsCenterY + mouseY * 0.2;
                
                this.opacity = Math.max(0, 1 - this.z / 1000);
                this.projectedSize = this.size * (1 - this.z / 1000) + 0.5;
            }
            
            draw(ctx, speed) {
                if (this.screenX < -50 || this.screenX > canvas.width + 50 || 
                    this.screenY < -50 || this.screenY > canvas.height + 50) {
                    return;
                }
                
                // 绘制拖尾效果
                if (speed > 3 && this.prevX && this.prevY) {
                    const gradient = ctx.createLinearGradient(
                        this.prevX, this.prevY,
                        this.screenX, this.screenY
                    );
                    
                    gradient.addColorStop(0, `rgba(255, 150, 100, 0)`);
                    gradient.addColorStop(1, `rgba(255, 150, 100, ${this.opacity * 0.6})`);
                    
                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = this.projectedSize;
                    ctx.beginPath();
                    ctx.moveTo(this.prevX, this.prevY);
                    ctx.lineTo(this.screenX, this.screenY);
                    ctx.stroke();
                }
                
                // 绘制星星本体
                ctx.save();
                ctx.globalAlpha = this.opacity;
                
                // 绘制星星光晕
                const glowSize = this.projectedSize * 3;
                const glowGradient = ctx.createRadialGradient(
                    this.screenX, this.screenY, 0,
                    this.screenX, this.screenY, glowSize
                );
                glowGradient.addColorStop(0, `rgba(255, 150, 100, ${this.opacity * 0.8})`);
                glowGradient.addColorStop(0.5, `rgba(255, 150, 100, ${this.opacity * 0.3})`);
                glowGradient.addColorStop(1, 'rgba(255, 150, 100, 0)');
                
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(this.screenX, this.screenY, glowSize, 0, Math.PI * 2);
                ctx.fill();
                
                // 绘制星星核心
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.screenX, this.screenY, this.projectedSize, 0, Math.PI * 2);
                ctx.fill();
                
                // 高速时的额外光效
                if (speed > 5) {
                    ctx.globalAlpha = this.opacity * 0.5;
                    ctx.fillStyle = '#ff6432';
                    ctx.beginPath();
                    ctx.arc(this.screenX, this.screenY, this.projectedSize * 0.5, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
        }

        class Starfield {
            constructor() {
                this.canvas = document.getElementById('starfield');
                this.ctx = this.canvas.getContext('2d');
                this.stars = [];
                this.numStars = 1500;
                this.speed = 2;
                this.mouseX = 0;
                this.mouseY = 0;
                this.isPaused = false;
                this.targetSpeed = this.speed;
                this.isMousePressed = false;
                this.baseSpeed = 1;
                this.boostSpeed = 8;
                this.markdownScrollActive = false;
                
                this.initCanvas();
                this.generateStars();
                this.bindEvents();
                this.animate();
                
                window.starfieldInstance = this;
            }
            
            initCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            
            generateStars() {
                for (let i = 0; i < this.numStars; i++) {
                    const x = (Math.random() - 0.5) * 2000;
                    const y = (Math.random() - 0.5) * 2000;
                    const z = Math.random() * 1000;
                    this.stars.push(new Star(x, y, z));
                }
            }
            
            bindEvents() {
                window.addEventListener('mousedown', (e) => {
                    this.isMousePressed = true;
                    this.targetSpeed = this.boostSpeed;
                });
                
                window.addEventListener('mouseup', (e) => {
                    this.isMousePressed = false;
                    this.targetSpeed = this.baseSpeed;
                });
                
                window.addEventListener('mousemove', (e) => {
                    this.mouseX = (e.clientX - window.innerWidth / 2) * 0.3;
                    this.mouseY = (e.clientY - window.innerHeight / 2) * 0.3;
                    
                    // 更新自定义光标位置
                    const cursor = document.querySelector('.custom-cursor');
                    if (cursor) {
                        cursor.style.left = e.clientX - 10 + 'px';
                        cursor.style.top = e.clientY - 10 + 'px';
                    }
                });
                
                window.addEventListener('wheel', (e) => {
                    if (this.markdownScrollActive) {
                        return;
                    }
                    
                    const projectList = document.getElementById('project-list');
                    const projectListRect = projectList.getBoundingClientRect();
                    
                    const isInProjectList = projectList.classList.contains('visible') &&
                        e.clientX >= projectListRect.left &&
                        e.clientX <= projectListRect.right &&
                        e.clientY >= projectListRect.top &&
                        e.clientY <= projectListRect.bottom;
                    
                    if (isInProjectList) {
                        return;
                    }
                    
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.5 : -0.5;
                    this.baseSpeed = Math.max(0.1, Math.min(15, this.baseSpeed + delta));
                    this.boostSpeed = Math.max(this.baseSpeed + 2, this.baseSpeed * 3);
                    
                    if (!this.isMousePressed) {
                        this.targetSpeed = this.baseSpeed;
                    } else {
                        this.targetSpeed = this.boostSpeed;
                    }
                }, { passive: false });
                
                window.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.isPaused = !this.isPaused;
                    }
                });
                
                window.addEventListener('resize', () => {
                    this.initCanvas();
                });
                
                this.canvas.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
                
                window.addEventListener('mouseleave', () => {
                    this.isMousePressed = false;
                    this.targetSpeed = this.baseSpeed;
                });
            }
            
            animate() {
                if (!this.isPaused) {
                    this.speed += (this.targetSpeed - this.speed) * 0.1;
                    
                    // 火星主题的背景色
                    this.ctx.fillStyle = 'rgba(20, 5, 5, 0.1)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // 绘制火星主题背景渐变
                    const gradient = this.ctx.createRadialGradient(
                        this.canvas.width / 2, this.canvas.height / 2, 0,
                        this.canvas.width / 2, this.canvas.height / 2, 
                        Math.max(this.canvas.width, this.canvas.height) / 2
                    );
                    gradient.addColorStop(0, 'rgba(46, 26, 26, 0.05)');
                    gradient.addColorStop(1, 'rgba(0, 0, 0, 0.1)');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // 更新和绘制星星
                    for (let star of this.stars) {
                        star.update(this.speed, this.mouseX, this.mouseY);
                        star.draw(this.ctx, this.speed);
                    }
                    
                    // 高速时的屏幕效果 - 火星红色
                    if (this.speed > 8) {
                        this.ctx.save();
                        this.ctx.globalAlpha = Math.min(0.15, (this.speed - 8) * 0.01);
                        this.ctx.fillStyle = '#331100';
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                        this.ctx.restore();
                    }
                }
                
                requestAnimationFrame(() => this.animate());
            }
        }

        // 初始化星空和火星
        window.addEventListener('load', () => {
            window.canvas = document.getElementById('starfield');
            new Starfield();
            new Mars3D();
            initProjectListScroll();
            initMarkdownScroll();
            initMusic();
            
            // 初始化自定义光标位置
            const cursor = document.querySelector('.custom-cursor');
            if (cursor) {
                cursor.style.left = window.innerWidth / 2 - 10 + 'px';
                cursor.style.top = window.innerHeight / 2 - 10 + 'px';
            }
        });
        
        // ESC键恢复视角
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const markdownDisplay = document.getElementById('markdown-display');
                if (markdownDisplay.classList.contains('visible')) {
                    closeMarkdownDisplay();
                } else if (isZoomedIn) {
                    handleMarsClick();
                }
            }
        });
    </script>
    
    <!-- 自定义光标 -->
    <div class="custom-cursor"></div>
</body>
</html>
